---
title: "Cardiac, TOP2 and DNA damage Genes"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## **ðŸ“Œ Log2CPM Boxplots for Cardiac and TOP2 Genes**

This analysis generates **boxplots for cardiac genes and TOP2 genes** across different treatments and timepoints.

---

## **ðŸ“Œ Load Required Libraries**
```{r load_libraries, echo=TRUE, message=FALSE}
library(ggplot2)
library(dplyr)
library(tidyr)
library(org.Hs.eg.db)
library(clusterProfiler)
```

## **ðŸ“Œ Read Log2CPM Data**
```{r load_File Paths, echo=TRUE,results='hide',message=FALSE}
# Load feature count matrix
boxplot1 <- read.csv("data/Feature_count_Matrix_Log2CPM_filtered.csv") %>% as.data.frame()

# Ensure column names are cleaned
colnames(boxplot1) <- trimws(gsub("^X", "", colnames(boxplot1)))  
```


## **ðŸ“Œ Define Genes of Interest**
```{r Genes of Interest, echo=TRUE, message=FALSE}
# Define the genes of interest
top2_genes <- c("TOP2A", "TOP2B")
cardiac_genes <- c("ACTN2", "CALR", "MYBPC3", "MYH6", "MYH7", "NKX2-5","MYL2", "RYR2", "SCN5A", "TNNI3", "TNNT2", "TTN")
dna_damage_genes <- c("TP53")  # Using correct gene symbol TP53
dna_repair_genes <- c("H2AZ1", "UBE2T", "MMS22L","PIAS3")
p53_target_genes <- c("IER5", "HHAT", "EPS8L2")

```


## **ðŸ“Œ Read and Process DEGs Data**
```{r load_Feature Count Matrix, echo=TRUE,results='hide',message=FALSE}
# Load Toptables
deg_files <- list.files("data/DEGs", pattern = "Toptable_.*\\.csv", full.names = TRUE)
deg_list <- lapply(deg_files, read.csv)
names(deg_list) <- gsub("data/DEGs/Toptable_|\\.csv", "", deg_files)  

# Function to check significance based on **Entrez_ID in the correct sample**
is_significant <- function(gene, drug, conc, timepoint) {
  condition <- paste(drug, conc, timepoint, sep = "_")
  if (!condition %in% names(deg_list)) return(FALSE)
  
  toptable <- deg_list[[condition]]
  gene_entrez <- boxplot1$ENTREZID[boxplot1$SYMBOL == gene]
  
  if (length(gene_entrez) == 0) return(FALSE)
  
  return(any(gene_entrez %in% toptable$Entrez_ID[toptable$adj.P.Val < 0.05]))
}
```


## **ðŸ“Œ Process Data for Plotting**
```{r Data for Plotting, echo=TRUE, message=FALSE}
process_gene_data <- function(gene) {
  # Filter log2CPM data for the gene
  gene_data <- boxplot1 %>% filter(SYMBOL == gene)
  
  # Reshape data
  long_data <- gene_data %>%
    pivot_longer(cols = -c(ENTREZID, SYMBOL, GENENAME), names_to = "Sample", values_to = "log2CPM") %>%
    mutate(
      Indv = case_when(
        grepl("75.1", Sample) ~ "1",
        grepl("78.1", Sample) ~ "2",
        grepl("87.1", Sample) ~ "3",
        grepl("17.3", Sample) ~ "4",
        grepl("84.1", Sample) ~ "5",
        grepl("90.1", Sample) ~ "6",
        TRUE ~ NA_character_
      ),
      Drug = case_when(
        grepl("CX.5461", Sample) ~ "CX",
        grepl("DOX", Sample) ~ "DOX",
        grepl("VEH", Sample) ~ "VEH",
        TRUE ~ NA_character_
      ),
      Conc. = case_when(
        grepl("_0.1_", Sample) ~ "0.1",
        grepl("_0.5_", Sample) ~ "0.5",
        TRUE ~ NA_character_
      ),
      Timepoint = case_when(
        grepl("_3$", Sample) ~ "3",
        grepl("_24$", Sample) ~ "24",
        grepl("_48$", Sample) ~ "48",
        TRUE ~ NA_character_
      ),
      Condition = paste(Drug, Conc., Timepoint, sep = "_")
    )

  # **Ensure Condition is Ordered Correctly**
  long_data$Condition <- factor(
    long_data$Condition, 
    levels = c(
      "CX_0.1_3", "CX_0.1_24", "CX_0.1_48", "CX_0.5_3", "CX_0.5_24", "CX_0.5_48",
      "DOX_0.1_3", "DOX_0.1_24", "DOX_0.1_48", "DOX_0.5_3", "DOX_0.5_24", "DOX_0.5_48",
      "VEH_0.1_3", "VEH_0.1_24", "VEH_0.1_48", "VEH_0.5_3", "VEH_0.5_24", "VEH_0.5_48"
    )
  )
  
  # Identify significant conditions **per Drug, Conc, and Timepoint**
  significance_labels <- long_data %>%
    distinct(Drug, Conc., Timepoint, Condition) %>%
    rowwise() %>%
    mutate(
      max_log2CPM = max(long_data$log2CPM[long_data$Condition == Condition], na.rm = TRUE),
      Significance = ifelse(is_significant(gene, Drug, Conc., Timepoint), "*", "")
    ) %>%
    filter(Significance != "") %>% ungroup()
  
  list(long_data = long_data, significance_labels = significance_labels)
}
```


## **ðŸ“ŒGenerate Boxplots for Cardiac Genes**
```{r Cardiac, echo=TRUE,message=FALSE}
for (gene in cardiac_genes) {
  data_info <- process_gene_data(gene)
  p <- ggplot(data_info$long_data, aes(x = Condition, y = log2CPM, fill = Drug)) +
    geom_boxplot(outlier.shape = NA) +
    scale_fill_manual(values = c("CX" = "#0000FF", "DOX" = "#e6d800", "VEH" = "#FF00FF")) +
    geom_point(aes(color = Indv), size = 2, alpha = 0.5, position = position_jitter(width = -1, height = 0)) +
    geom_text(data = data_info$significance_labels, aes(x = Condition, y = max_log2CPM + 0.5, label = Significance),
              inherit.aes = FALSE, size = 6, color = "black") +
    ggtitle(paste("Log2CPM Expression of", gene)) +
    labs(x = "Treatment", y = "log2CPM") +
    theme_bw() +
    theme(plot.title = element_text(size = rel(2), hjust = 0.5),
          axis.title = element_text(size = 15, color = "black"),
          axis.text.x = element_text(size = 10, color = "black", angle = 90, hjust = 1))
  
  print(p)
}
```

## **ðŸ“ŒGenerate Boxplots for Veh_Cardiac Genes**
```{r Veh_cardiac, echo=TRUE,message=FALSE, fig.width=10,fig.height=7}
# ðŸ“Œ Prepare data
cardiac_data <- boxplot1 %>%
  filter(SYMBOL %in% cardiac_genes) %>%
  pivot_longer(cols = -c(ENTREZID, SYMBOL, GENENAME), names_to = "Sample", values_to = "log2CPM") %>%
  mutate(
    Indv = case_when(
      grepl("75.1", Sample) ~ "1",
      grepl("78.1", Sample) ~ "2",
      grepl("87.1", Sample) ~ "3",
      grepl("17.3", Sample) ~ "4",
      grepl("84.1", Sample) ~ "5",
      grepl("90.1", Sample) ~ "6",
      TRUE ~ NA_character_
    ),
    Drug = case_when(
      grepl("CX.5461", Sample) ~ "CX",
      grepl("DOX", Sample) ~ "DOX",
      grepl("VEH", Sample) ~ "VEH",
      TRUE ~ NA_character_
    ),
    Conc. = case_when(
      grepl("_0.1_", Sample) ~ "0.1",
      grepl("_0.5_", Sample) ~ "0.5",
      TRUE ~ NA_character_
    ),
    Timepoint = case_when(
      grepl("_3$", Sample) ~ "3",
      grepl("_24$", Sample) ~ "24",
      grepl("_48$", Sample) ~ "48",
      TRUE ~ NA_character_
    )
  ) %>%
  filter(Drug == "VEH")

# ðŸ“Œ Set factors
cardiac_data$SYMBOL <- factor(cardiac_data$SYMBOL, levels = cardiac_genes)
cardiac_data$Timepoint <- factor(cardiac_data$Timepoint, levels = c("3", "24", "48"))
cardiac_data$Conc. <- factor(cardiac_data$Conc., levels = c("0.1", "0.5"))

# Add a new combined X-axis label: Gene + Timepoint
cardiac_data <- cardiac_data %>%
  mutate(Gene_Time = interaction(SYMBOL, Timepoint, sep = "_"),
         SYMBOL = factor(SYMBOL, levels = cardiac_genes),
         Timepoint = factor(Timepoint, levels = c("3", "24", "48")),
         Conc. = factor(Conc., levels = c("0.1", "0.5")))

# Plot using Gene-Time combination for clean x-axis dodge
ggplot(cardiac_data, aes(x = SYMBOL, y = log2CPM, fill = Timepoint)) +
  geom_boxplot(
    aes(group = interaction(SYMBOL, Timepoint)),
    position = position_dodge(width = 0.8),
    outlier.shape = NA,
    width = 0.6
  ) +
  geom_point(
    aes(color = Indv, group = interaction(SYMBOL, Timepoint)),
    position = position_dodge(width = 0.8),
    size = 2,
    alpha = 0.8
  ) +
  facet_grid(. ~ Conc., labeller = label_both) +
  labs(
    title = "Cardiac Gene Expression in Vehicle-Treated iPSC-CMs",
    x = "Cardiac Gene",
    y = "log2CPM"
  ) +
  theme_bw() +
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    axis.text.x = element_text(angle = 45, hjust = 1, size = 11),
    axis.title = element_text(size = 14),
    strip.text = element_text(size = 13, face = "bold"),
    legend.title = element_text(face = "bold"),
    legend.position = "right"
  )
```

## **ðŸ“ŒGenerate Boxplots for TOP2 Genes**
```{r TOP2, echo=TRUE,message=FALSE}
for (gene in top2_genes) {
  data_info <- process_gene_data(gene)
  p <- ggplot(data_info$long_data, aes(x = Condition, y = log2CPM, fill = Drug)) +
    geom_boxplot(outlier.shape = NA) +
    scale_fill_manual(values = c("CX" = "#0000FF", "DOX" = "#e6d800", "VEH" = "#FF00FF")) +
    geom_point(aes(color = Indv), size = 2, alpha = 0.5, position = position_jitter(width = -1, height = 0)) +
    geom_text(data = data_info$significance_labels, aes(x = Condition, y = max_log2CPM + 0.5, label = Significance),
              inherit.aes = FALSE, size = 6, color = "black") +
    ggtitle(paste("Log2CPM Expression of", gene)) +
    labs(x = "Treatment", y = "log2CPM") +
    theme_bw() +
    theme(plot.title = element_text(size = rel(2), hjust = 0.5),
          axis.title = element_text(size = 15, color = "black"),
          axis.text.x = element_text(size = 10, color = "black", angle = 90, hjust = 1))
  
  print(p)
}
```

## **ðŸ“Œ Generate Boxplots for TP53 Genes**
```{r DNA Damage, echo=TRUE,message=FALSE}
for (gene in dna_damage_genes) {
  data_info <- process_gene_data(gene)
  p <- ggplot(data_info$long_data, aes(x = Condition, y = log2CPM, fill = Drug)) +
    geom_boxplot(outlier.shape = NA) +
    scale_fill_manual(values = c("CX" = "#0000FF", "DOX" = "#e6d800", "VEH" = "#FF00FF")) +
    geom_point(aes(color = Indv), size = 2, alpha = 0.5, position = position_jitter(width = -1, height = 0)) +
    geom_text(data = data_info$significance_labels, aes(x = Condition, y = max_log2CPM + 0.5, label = Significance),
              inherit.aes = FALSE, size = 6, color = "black") +
    ggtitle(paste("Log2CPM Expression of", gene)) +
    labs(x = "Treatment", y = "log2CPM") +
    theme_bw() +
    theme(plot.title = element_text(size = rel(2), hjust = 0.5),
          axis.title = element_text(size = 15, color = "black"),
          axis.text.x = element_text(size = 10, color = "black", angle = 90, hjust = 1))
  
  print(p)
}
```

##**ðŸ“Œ DNA Damage Repair Genes Proportion**

## **ðŸ“Œ Read and Process DEG Data**
```{r load_DEGs, echo=TRUE, results='hide', message=FALSE, warning=FALSE}
# Load DEGs Data
CX_0.1_3 <- read.csv("data/DEGs/Toptable_CX_0.1_3.csv")
CX_0.1_24 <- read.csv("data/DEGs/Toptable_CX_0.1_24.csv")
CX_0.1_48 <- read.csv("data/DEGs/Toptable_CX_0.1_48.csv")
CX_0.5_3 <- read.csv("data/DEGs/Toptable_CX_0.5_3.csv")
CX_0.5_24 <- read.csv("data/DEGs/Toptable_CX_0.5_24.csv")
CX_0.5_48 <- read.csv("data/DEGs/Toptable_CX_0.5_48.csv")

DOX_0.1_3 <- read.csv("data/DEGs/Toptable_DOX_0.1_3.csv")
DOX_0.1_24 <- read.csv("data/DEGs/Toptable_DOX_0.1_24.csv")
DOX_0.1_48 <- read.csv("data/DEGs/Toptable_DOX_0.1_48.csv")
DOX_0.5_3 <- read.csv("data/DEGs/Toptable_DOX_0.5_3.csv")
DOX_0.5_24 <- read.csv("data/DEGs/Toptable_DOX_0.5_24.csv")
DOX_0.5_48 <- read.csv("data/DEGs/Toptable_DOX_0.5_48.csv")

# Extract Significant DEGs
DEGs <- list(
  "CX_0.1_3" = CX_0.1_3$Entrez_ID[CX_0.1_3$adj.P.Val < 0.05],
  "CX_0.1_24" = CX_0.1_24$Entrez_ID[CX_0.1_24$adj.P.Val < 0.05],
  "CX_0.1_48" = CX_0.1_48$Entrez_ID[CX_0.1_48$adj.P.Val < 0.05],
  "CX_0.5_3" = CX_0.5_3$Entrez_ID[CX_0.5_3$adj.P.Val < 0.05],
  "CX_0.5_24" = CX_0.5_24$Entrez_ID[CX_0.5_24$adj.P.Val < 0.05],
  "CX_0.5_48" = CX_0.5_48$Entrez_ID[CX_0.5_48$adj.P.Val < 0.05],
  "DOX_0.1_3" = DOX_0.1_3$Entrez_ID[DOX_0.1_3$adj.P.Val < 0.05],
  "DOX_0.1_24" = DOX_0.1_24$Entrez_ID[DOX_0.1_24$adj.P.Val < 0.05],
  "DOX_0.1_48" = DOX_0.1_48$Entrez_ID[DOX_0.1_48$adj.P.Val < 0.05],
  "DOX_0.5_3" = DOX_0.5_3$Entrez_ID[DOX_0.5_3$adj.P.Val < 0.05],
  "DOX_0.5_24" = DOX_0.5_24$Entrez_ID[DOX_0.5_24$adj.P.Val < 0.05],
  "DOX_0.5_48" = DOX_0.5_48$Entrez_ID[DOX_0.5_48$adj.P.Val < 0.05]
)

# Extract Significant DEGs
DEG1 <- CX_0.1_3$Entrez_ID[CX_0.1_3$adj.P.Val < 0.05]
DEG2 <- CX_0.1_24$Entrez_ID[CX_0.1_24$adj.P.Val < 0.05]
DEG3 <- CX_0.1_48$Entrez_ID[CX_0.1_48$adj.P.Val < 0.05]
DEG4 <- CX_0.5_3$Entrez_ID[CX_0.5_3$adj.P.Val < 0.05]
DEG5 <- CX_0.5_24$Entrez_ID[CX_0.5_24$adj.P.Val < 0.05]
DEG6 <- CX_0.5_48$Entrez_ID[CX_0.5_48$adj.P.Val < 0.05]

DEG7 <- DOX_0.1_3$Entrez_ID[DOX_0.1_3$adj.P.Val < 0.05]
DEG8 <- DOX_0.1_24$Entrez_ID[DOX_0.1_24$adj.P.Val < 0.05]
DEG9 <- DOX_0.1_48$Entrez_ID[DOX_0.1_48$adj.P.Val < 0.05]
DEG10 <- DOX_0.5_3$Entrez_ID[DOX_0.5_3$adj.P.Val < 0.05]
DEG11 <- DOX_0.5_24$Entrez_ID[DOX_0.5_24$adj.P.Val < 0.05]
DEG12 <- DOX_0.5_48$Entrez_ID[DOX_0.5_48$adj.P.Val < 0.05]
```

## **ðŸ“Œ DNA Damage Repair Proportion with Chi-Square Test**
```{r DNA_Damage_Proportion, echo=TRUE, results='hide', message=FALSE, warning=FALSE}
# Read DNA Damage Genes List
DNA_damage <- read.csv("data/DNA_Damage.csv", stringsAsFactors = FALSE)

# Convert gene symbols to Entrez IDs
DNA_damage <- DNA_damage %>%
  mutate(Entrez_ID = mapIds(org.Hs.eg.db,
                            keys = Symbol,
                            column = "ENTREZID",
                            keytype = "SYMBOL",
                            multiVals = "first"))

# Extract DNA damage gene Entrez IDs
DNA_damage_genes <- na.omit(DNA_damage$Entrez_ID)
total_DNA_damage_genes <- length(DNA_damage_genes)  # Total number of DNA damage genes

# Define CX-5461 DEG lists
CX_DEGs <- list(
  "CX_0.1_3" = DEG1, "CX_0.1_24" = DEG2, "CX_0.1_48" = DEG3,
  "CX_0.5_3" = DEG4, "CX_0.5_24" = DEG5, "CX_0.5_48" = DEG6
)

# Define DOX DEG lists
DOX_DEGs <- list(
  "DOX_0.1_3" = DEG7, "DOX_0.1_24" = DEG8, "DOX_0.1_48" = DEG9,
  "DOX_0.5_3" = DEG10, "DOX_0.5_24" = DEG11, "DOX_0.5_48" = DEG12
)

# Function to calculate the presence of DNA damage genes in DEGs
calculate_proportion <- function(deg_list, drug_name) {
  data.frame(
    Sample = names(deg_list),
    Drug = drug_name,
    DNA_Damage_DEGs = sapply(deg_list, function(ids) sum(ids %in% DNA_damage_genes)),  # DEGs present in DNA damage set
    Non_DNA_Damage_DEGs = sapply(deg_list, function(ids) total_DNA_damage_genes - sum(ids %in% DNA_damage_genes))  # Remaining DNA damage genes
  ) %>%
    mutate(
      Yes_Proportion = (DNA_Damage_DEGs / total_DNA_damage_genes) * 100,  # Percentage of DEGs in DNA damage genes
      No_Proportion = (Non_DNA_Damage_DEGs / total_DNA_damage_genes) * 100  # Remaining DNA damage genes as No
    )
}

# Calculate proportions for CX-5461 and DOX
CX_proportion <- calculate_proportion(CX_DEGs, "CX-5461")
DOX_proportion <- calculate_proportion(DOX_DEGs, "DOX")

# Combine data
proportion_data <- bind_rows(CX_proportion, DOX_proportion)

# Convert to long format for stacked bar plot
proportion_long <- proportion_data %>%
  select(Sample, Drug, Yes_Proportion, No_Proportion) %>%
  pivot_longer(cols = c(Yes_Proportion, No_Proportion), names_to = "Category", values_to = "Percentage") %>%
  mutate(Category = ifelse(Category == "Yes_Proportion", "Yes", "No"))

# **Ensure correct order of samples on X-axis**
sample_order <- c(
  "CX_0.1_3", "CX_0.1_24", "CX_0.1_48", "CX_0.5_3", "CX_0.5_24", "CX_0.5_48",
  "DOX_0.1_3", "DOX_0.1_24", "DOX_0.1_48", "DOX_0.5_3", "DOX_0.5_24", "DOX_0.5_48"
)
proportion_long$Sample <- factor(proportion_long$Sample, levels = sample_order, ordered = TRUE)

# **Fix: Ensure "Yes" is on top and "No" is at the bottom in stacked bars**
proportion_long$Category <- factor(proportion_long$Category, levels = c("Yes", "No"))  # Ensures "Yes" on top, "No" at bottom

# **Perform Chi-Square Test for CX vs DOX at each timepoint**
chi_square_results <- data.frame(Sample = character(), P_Value = numeric())

for (i in seq(1, 6)) {  # Pairwise comparison (CX vs DOX)
  cx_sample <- sample_order[i]
  dox_sample <- sample_order[i + 6]  # Matches CX_0.1_3 with DOX_0.1_3, etc.
  
  cx_data <- filter(proportion_data, Sample == cx_sample)
  dox_data <- filter(proportion_data, Sample == dox_sample)
  
  # Construct contingency table for Chi-Square test
  contingency_table <- matrix(
    c(cx_data$DNA_Damage_DEGs, cx_data$Non_DNA_Damage_DEGs,
      dox_data$DNA_Damage_DEGs, dox_data$Non_DNA_Damage_DEGs),
    nrow = 2, byrow = TRUE
  )
  
  # Run Chi-Square Test
  test_result <- chisq.test(contingency_table)
  p_value <- test_result$p.value
  
  # Store results
  chi_square_results <- rbind(chi_square_results, data.frame(Sample = cx_sample, P_Value = p_value))
}

# Add significance stars
chi_square_results$Significant <- ifelse(chi_square_results$P_Value < 0.05, "*", "")

# Merge Chi-Square results
proportion_long <- left_join(proportion_long, chi_square_results, by = "Sample")

# **Save output**
write.csv(proportion_long, "C:/Work/Postdoc_UTMB/CX-5461 Project/Transcriptome literatures/lit2/Proportion_Stacked_DNA_Damage_DEGs_with_ChiSquare.csv", row.names = FALSE)


# Define correct factor orders for samples
sample_order <- c(
  "CX_0.1_3", "CX_0.1_24", "CX_0.1_48", "CX_0.5_3", "CX_0.5_24", "CX_0.5_48",
  "DOX_0.1_3", "DOX_0.1_24", "DOX_0.1_48", "DOX_0.5_3", "DOX_0.5_24", "DOX_0.5_48"
)

# Reapply factor levels for correct order in both proportion_data and proportion_long
proportion_data$Sample <- factor(proportion_data$Sample, levels = sample_order, ordered = TRUE)
proportion_long$Sample <- factor(proportion_long$Sample, levels = sample_order, ordered = TRUE)

# **Fix: Ensure "Yes" is on top and "No" is at the bottom in stacked bars**
proportion_long$Category <- factor(proportion_long$Category, levels = c("Yes", "No"))
```


## **ðŸ“Œ DNA Damage Repair Proportion Plot**
```{r ggplot, echo=TRUE, message=FALSE}

# **Generate Stacked Bar Plot with Correct X-Axis Order**
ggplot(proportion_long, aes(x = Sample, y = Percentage, fill = Category)) +
  geom_bar(stat = "identity", position = "stack") +  # Stacked bars
  geom_text(data = subset(proportion_long, Significant == "*"),
            aes(x = Sample, y = 102, label = "*"),  # Position stars slightly above 100%
            size = 6, color = "black", fontface = "bold") +
  scale_y_continuous(labels = scales::percent_format(scale = 1), limits = c(0, 105)) +  # Increase Y-axis slightly
  scale_fill_manual(values = c("Yes" = "#e41a1c", "No" = "#377eb8")) +  # Yes (Red), No (Blue)
  labs(
    title = "Proportion of CX-5461 and DOX DEGs in\nDNA Damage Repair Genes with Significance",
    x = "Samples (CX-5461 and DOX)",
    y = "Percentage",
    fill = "Category"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = rel(1.5), hjust = 0.5),
    axis.title = element_text(size = 15, color = "black"),
    axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
    legend.title = element_blank(),
    panel.border = element_rect(color = "black", fill = NA, linewidth = 1.2),
    strip.background = element_blank(),
    strip.text = element_text(size = 12, face = "bold")
  )
```

## **ðŸ“Œ DNA Damage Repair abs logFC distribution**
```{r abslogFC DNA damage, echo=TRUE, message=FALSE}
# Load necessary libraries
library(dplyr)
library(ggplot2)
library(tidyr)
library(org.Hs.eg.db)
library(rstatix)

# Read DNA Damage Response Gene List
DNA_damage <- read.csv("data/DNA_Damage.csv", stringsAsFactors = FALSE)

# Convert gene symbols to Entrez IDs
DNA_damage <- DNA_damage %>%
  mutate(Entrez_ID = mapIds(org.Hs.eg.db,
                            keys = Symbol,
                            column = "ENTREZID",
                            keytype = "SYMBOL",
                            multiVals = "first"))

DNA_damage_genes <- na.omit(DNA_damage$Entrez_ID)

all_toptables <- bind_rows(
  CX_0.1_3 %>% mutate(Drug = "CX.5461", Concentration = 0.1, Timepoint = "3"),
  CX_0.1_24 %>% mutate(Drug = "CX.5461", Concentration = 0.1, Timepoint = "24"),
  CX_0.1_48 %>% mutate(Drug = "CX.5461", Concentration = 0.1, Timepoint = "48"),
  CX_0.5_3 %>% mutate(Drug = "CX.5461", Concentration = 0.5, Timepoint = "3"),
  CX_0.5_24 %>% mutate(Drug = "CX.5461", Concentration = 0.5, Timepoint = "24"),
  CX_0.5_48 %>% mutate(Drug = "CX.5461", Concentration = 0.5, Timepoint = "48"),
  DOX_0.1_3 %>% mutate(Drug = "DOX", Concentration = 0.1, Timepoint = "3"),
  DOX_0.1_24 %>% mutate(Drug = "DOX", Concentration = 0.1, Timepoint = "24"),
  DOX_0.1_48 %>% mutate(Drug = "DOX", Concentration = 0.1, Timepoint = "48"),
  DOX_0.5_3 %>% mutate(Drug = "DOX", Concentration = 0.5, Timepoint = "3"),
  DOX_0.5_24 %>% mutate(Drug = "DOX", Concentration = 0.5, Timepoint = "24"),
  DOX_0.5_48 %>% mutate(Drug = "DOX", Concentration = 0.5, Timepoint = "48")
)

filtered_toptables <- all_toptables %>%
  filter(Entrez_ID %in% DNA_damage_genes) %>%
  mutate(abs_logFC = abs(logFC))

filtered_toptables <- filtered_toptables %>%
  mutate(
    Drug = factor(Drug, levels = c("CX.5461", "DOX")),  # CX first
    Timepoint = factor(Timepoint, levels = c("3", "24", "48"), 
                       labels = c("Timepoint: 3 hours", "Timepoint: 24 hours", "Timepoint: 48 hours")),
    Concentration = factor(Concentration, levels = c(0.1, 0.5), 
                           labels = c("Concentration: 0.1", "Concentration: 0.5"))
  )

wilcox_results <- filtered_toptables %>%
  group_by(Timepoint, Concentration) %>%
  wilcox_test(abs_logFC ~ Drug) %>%
  adjust_pvalue(method = "bonferroni") %>%
  mutate(significance = ifelse(p < 0.05, "*", "")) 

star_positions <- filtered_toptables %>%
  group_by(Timepoint, Concentration, Drug) %>%
  summarise(y_pos = max(abs_logFC, na.rm = TRUE) + 0.2, .groups = "drop") %>%
  group_by(Timepoint, Concentration) %>%
  summarise(y_pos = max(y_pos), .groups = "drop")

wilcox_results_plot <- wilcox_results %>%
  left_join(star_positions, by = c("Timepoint", "Concentration")) %>%
  mutate(x_position = 1.5)  # Place stars in the middle between CX & DOX

ggplot(filtered_toptables, aes(x = Drug, y = abs_logFC, fill = Drug)) +
  geom_boxplot() +
  scale_fill_manual(values = c("CX.5461" = "blue", "DOX" = "red")) +  
  facet_grid(Concentration ~ Timepoint) +  
  geom_text(
    data = wilcox_results_plot, 
    aes(x = x_position, y = y_pos, label = significance), 
    size = 6, fontface = "bold", color = "black", inherit.aes = FALSE
  ) +
  theme_bw() +
  xlab("Drugs") +
  ylab("|Log Fold Change|") +  
  ggtitle("|Log Fold Change| for DNA Damage Repair Genes") +
  theme(
    plot.title = element_text(size = rel(1.5), hjust = 0.5),
    axis.title = element_text(size = 15, color = "black"),
    axis.line = element_line(linewidth = 1.5),
    strip.background = element_rect(fill = "gray"),  
    strip.text = element_text(size = 12, color = "black", face = "bold"),  
    axis.text.x = element_text(size = 8, color = "black", angle = 15)
  )
```

## **ðŸ“Œ DNA Damage Repair logFC distribution**
```{r logFC DNA damage, echo=TRUE, message=FALSE}
# Load necessary libraries
library(dplyr)
library(ggplot2)
library(tidyr)
library(org.Hs.eg.db)
library(car)  # For Levene's Test

# Read DNA Damage Response Gene List
DNA_damage <- read.csv("data/DNA_Damage.csv", stringsAsFactors = FALSE)

# Convert gene symbols to Entrez IDs
DNA_damage <- DNA_damage %>%
  mutate(Entrez_ID = mapIds(org.Hs.eg.db,
                            keys = Symbol,
                            column = "ENTREZID",
                            keytype = "SYMBOL",
                            multiVals = "first"))

DNA_damage_genes <- na.omit(DNA_damage$Entrez_ID)

all_toptables <- bind_rows(
  CX_0.1_3 %>% mutate(Drug = "CX.5461", Concentration = 0.1, Timepoint = "3"),
  CX_0.1_24 %>% mutate(Drug = "CX.5461", Concentration = 0.1, Timepoint = "24"),
  CX_0.1_48 %>% mutate(Drug = "CX.5461", Concentration = 0.1, Timepoint = "48"),
  CX_0.5_3 %>% mutate(Drug = "CX.5461", Concentration = 0.5, Timepoint = "3"),
  CX_0.5_24 %>% mutate(Drug = "CX.5461", Concentration = 0.5, Timepoint = "24"),
  CX_0.5_48 %>% mutate(Drug = "CX.5461", Concentration = 0.5, Timepoint = "48"),
  DOX_0.1_3 %>% mutate(Drug = "DOX", Concentration = 0.1, Timepoint = "3"),
  DOX_0.1_24 %>% mutate(Drug = "DOX", Concentration = 0.1, Timepoint = "24"),
  DOX_0.1_48 %>% mutate(Drug = "DOX", Concentration = 0.1, Timepoint = "48"),
  DOX_0.5_3 %>% mutate(Drug = "DOX", Concentration = 0.5, Timepoint = "3"),
  DOX_0.5_24 %>% mutate(Drug = "DOX", Concentration = 0.5, Timepoint = "24"),
  DOX_0.5_48 %>% mutate(Drug = "DOX", Concentration = 0.5, Timepoint = "48")
)

filtered_toptables <- all_toptables %>%
  filter(Entrez_ID %in% DNA_damage_genes)

filtered_toptables <- filtered_toptables %>%
  mutate(
    Drug = factor(Drug, levels = c("CX.5461", "DOX")),  # CX first
    Timepoint = factor(Timepoint, levels = c("3", "24", "48"), 
                       labels = c("Timepoint: 3 hours", "Timepoint: 24 hours", "Timepoint: 48 hours")),
    Concentration = factor(Concentration, levels = c(0.1, 0.5), 
                           labels = c("Concentration: 0.1", "Concentration: 0.5"))
  )

levene_results <- filtered_toptables %>%
  group_by(Timepoint, Concentration) %>%
  summarise(p_value = leveneTest(logFC ~ Drug, data = .)$`Pr(>F)`[1], .groups = "drop") %>%
  mutate(significance = ifelse(p_value < 0.05, "*", ""))  # Use p < 0.05 threshold for stars

# **ðŸ”¹ Determine Y-axis position for Stars**
star_positions <- filtered_toptables %>%
  group_by(Timepoint, Concentration, Drug) %>%
  summarise(y_pos = max(logFC, na.rm = TRUE) + 0.5, .groups = "drop") %>%
  group_by(Timepoint, Concentration) %>%
  summarise(y_pos = max(y_pos), .groups = "drop")

# **ðŸ”¹ Merge Levene test results with Y positions**
levene_results_plot <- levene_results %>%
  left_join(star_positions, by = c("Timepoint", "Concentration")) %>%
  mutate(x_position = 1.5)  # Centered between CX & DOX

ggplot(filtered_toptables, aes(x = Drug, y = logFC, fill = Drug)) +
  geom_violin(trim = FALSE, alpha = 0.5) +  # Violin plot for logFC
  geom_boxplot(width = 0.1, outlier.shape = NA, color = "black", alpha = 0.5) +  # Add boxplot inside violin
  scale_fill_manual(values = c("CX.5461" = "blue", "DOX" = "red")) +  
  facet_grid(Concentration ~ Timepoint) +  
  geom_text(
    data = levene_results_plot %>% filter(significance == "*"),  # Only plot significant comparisons
    aes(x = x_position, y = y_pos, label = significance), 
    size = 6, fontface = "bold", color = "black", inherit.aes = FALSE
  ) +
  theme_bw() +
  xlab("Drugs") +
  ylab("Log Fold Change") +  
  ggtitle("Log Fold Change for DNA Damage Repair Genes") +
  theme(
    plot.title = element_text(size = rel(1.5), hjust = 0.5),
    axis.title = element_text(size = 15, color = "black"),
    axis.line = element_line(linewidth = 1.5),
    strip.background = element_rect(fill = "gray"),  
    strip.text = element_text(size = 12, color = "black", face = "bold"),  
    axis.text.x = element_text(size = 8, color = "black", angle = 15)
  )
```

## **ðŸ“Œ Generate Boxplots for DNA Damage Repair Genes**
```{r DNA Damage Repair, echo=TRUE, message=FALSE}
for (gene in dna_repair_genes) {
  data_info <- process_gene_data(gene)
  p <- ggplot(data_info$long_data, aes(x = Condition, y = log2CPM, fill = Drug)) +
    geom_boxplot(outlier.shape = NA) +
    scale_fill_manual(values = c("CX" = "#0000FF", "DOX" = "#e6d800", "VEH" = "#FF00FF")) +
    geom_point(aes(color = Indv), size = 2, alpha = 0.5, position = position_jitter(width = 0.2, height = 0)) +
    geom_text(data = data_info$significance_labels, aes(x = Condition, y = max_log2CPM + 0.5, label = Significance),
              inherit.aes = FALSE, size = 6, color = "black") +
    ggtitle(paste("Log2CPM Expression of", gene)) +
    labs(x = "Treatment", y = "log2CPM") +
    theme_bw() +
    theme(plot.title = element_text(size = rel(2), hjust = 0.5),
          axis.title = element_text(size = 15, color = "black"),
          axis.text.x = element_text(size = 10, color = "black", angle = 90, hjust = 1))
  
  print(p)
}
```


## **ðŸ“Œ P53 target genes Proportion**

## **ðŸ“Œ P53 target genes Proportion with Chi-Square Test**
```{r P53_target_Proportion1, echo=TRUE, message=FALSE, warning=FALSE}
# Load necessary libraries
library(dplyr)
library(ggplot2)
library(tidyr)
library(org.Hs.eg.db)

# Read P53 Target Genes List
P53_Target <- read.csv("data/P53_Target.csv", stringsAsFactors = FALSE)

# Convert gene symbols to Entrez IDs
P53_Target <- P53_Target %>%
  mutate(Entrez_ID = mapIds(org.Hs.eg.db,
                            keys = Symbol,
                            column = "ENTREZID",
                            keytype = "SYMBOL",
                            multiVals = "first"))

# Extract valid Entrez_IDs
P53_Target_genes <- na.omit(P53_Target$Entrez_ID)
total_P53_Target_genes <- length(P53_Target_genes)  # Total number of P53 target genes

# Function to calculate the presence of P53 target genes in DEGs
calculate_proportion <- function(deg_list, drug_name) {
  data.frame(
    Sample = names(deg_list),
    Drug = drug_name,
    P53_Target_DEGs = sapply(deg_list, function(ids) sum(ids %in% P53_Target_genes)),  # DEGs present in P53 target set
    Non_P53_Target_DEGs = sapply(deg_list, function(ids) total_P53_Target_genes - sum(ids %in% P53_Target_genes))  # Remaining P53 target genes
  ) %>%
    mutate(
      Yes_Proportion = (P53_Target_DEGs / total_P53_Target_genes) * 100,  # Percentage of DEGs in P53 target genes
      No_Proportion = (Non_P53_Target_DEGs / total_P53_Target_genes) * 100  # Remaining P53 target genes as No
    )
}

# Define CX-5461 and DOX DEG lists
CX_DEGs <- list(
  "CX_0.1_3" = DEG1, "CX_0.1_24" = DEG2, "CX_0.1_48" = DEG3,
  "CX_0.5_3" = DEG4, "CX_0.5_24" = DEG5, "CX_0.5_48" = DEG6
)

DOX_DEGs <- list(
  "DOX_0.1_3" = DEG7, "DOX_0.1_24" = DEG8, "DOX_0.1_48" = DEG9,
  "DOX_0.5_3" = DEG10, "DOX_0.5_24" = DEG11, "DOX_0.5_48" = DEG12
)

# Calculate proportions for CX-5461 and DOX
CX_proportion <- calculate_proportion(CX_DEGs, "CX-5461")
DOX_proportion <- calculate_proportion(DOX_DEGs, "DOX")

# Combine data
proportion_data <- bind_rows(CX_proportion, DOX_proportion)

# Convert to long format for stacked bar plot
proportion_long <- proportion_data %>%
  select(Sample, Drug, Yes_Proportion, No_Proportion) %>%
  pivot_longer(cols = c(Yes_Proportion, No_Proportion), names_to = "Category", values_to = "Percentage") %>%
  mutate(Category = ifelse(Category == "Yes_Proportion", "Yes", "No"))

# **Ensure correct order of samples on X-axis**
sample_order <- c(
  "CX_0.1_3", "CX_0.1_24", "CX_0.1_48", "CX_0.5_3", "CX_0.5_24", "CX_0.5_48",
  "DOX_0.1_3", "DOX_0.1_24", "DOX_0.1_48", "DOX_0.5_3", "DOX_0.5_24", "DOX_0.5_48"
)
proportion_long$Sample <- factor(proportion_long$Sample, levels = sample_order, ordered = TRUE)

# **Ensure "Yes" is on top and "No" is at the bottom in stacked bars**
proportion_long$Category <- factor(proportion_long$Category, levels = c("Yes", "No"))

# **Perform Chi-Square Test for CX vs DOX at each timepoint**
chi_square_results <- data.frame(Sample = character(), P_Value = numeric())

for (i in seq(1, 6)) {  # Pairwise comparison (CX vs DOX)
  cx_sample <- sample_order[i]
  dox_sample <- sample_order[i + 6]  # Matches CX_0.1_3 with DOX_0.1_3, etc.
  
  cx_data <- filter(proportion_data, Sample == cx_sample)
  dox_data <- filter(proportion_data, Sample == dox_sample)
  
  # Construct contingency table for Chi-Square test
  contingency_table <- matrix(
    c(cx_data$P53_Target_DEGs, cx_data$Non_P53_Target_DEGs,
      dox_data$P53_Target_DEGs, dox_data$Non_P53_Target_DEGs),
    nrow = 2, byrow = TRUE
  )
  
  # Run Chi-Square Test
  test_result <- chisq.test(contingency_table)
  p_value <- test_result$p.value
  
  # Store results
  chi_square_results <- rbind(chi_square_results, data.frame(Sample = cx_sample, P_Value = p_value))
}

# Add significance stars
chi_square_results$Significant <- ifelse(chi_square_results$P_Value < 0.05, "*", "")

# Merge Chi-Square results
proportion_long <- left_join(proportion_long, chi_square_results, by = "Sample")

# **Save output**
write.csv(proportion_long, "C:/Work/Postdoc_UTMB/CX-5461 Project/Transcriptome literatures/lit2/Proportion_Stacked_P53_Target_DEGs_with_ChiSquare.csv", row.names = FALSE)

# Define correct factor orders for samples
sample_order <- c(
  "CX_0.1_3", "CX_0.1_24", "CX_0.1_48", "CX_0.5_3", "CX_0.5_24", "CX_0.5_48",
  "DOX_0.1_3", "DOX_0.1_24", "DOX_0.1_48", "DOX_0.5_3", "DOX_0.5_24", "DOX_0.5_48"
)

# Reapply factor levels for correct order in both proportion_data and proportion_long
proportion_data$Sample <- factor(proportion_data$Sample, levels = sample_order, ordered = TRUE)
proportion_long$Sample <- factor(proportion_long$Sample, levels = sample_order, ordered = TRUE)

# **Fix: Ensure "Yes" is on top and "No" is at the bottom in stacked bars**
proportion_long$Category <- factor(proportion_long$Category, levels = c("Yes", "No"))


# **Generate Stacked Bar Plot with Correct X-Axis Order**
ggplot(proportion_long, aes(x = Sample, y = Percentage, fill = Category)) +
  geom_bar(stat = "identity", position = "stack") +  # Stacked bars
  geom_text(data = subset(proportion_long, Significant == "*"),
            aes(x = Sample, y = 102, label = "*"),  # Position stars slightly above 100%
            size = 6, color = "black", fontface = "bold") +
  scale_y_continuous(labels = scales::percent_format(scale = 1), limits = c(0, 105)) +  # Increase Y-axis slightly
  scale_fill_manual(values = c("Yes" = "#e41a1c", "No" = "#377eb8")) +  # Yes (Red), No (Blue)
  labs(
    title = "Proportion of CX-5461 and DOX DEGs in\n P53 Target Genes with Significance",
    x = "Samples (CX-5461 and DOX)",
    y = "Percentage",
    fill = "Category"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = rel(1.5), hjust = 0.5),
    axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
    legend.title = element_blank(),
    panel.border = element_rect(color = "black", fill = NA, linewidth = 1.2),
    strip.background = element_blank(),
    strip.text = element_text(size = 12, face = "bold")
  )
```


## **ðŸ“Œ P53 target genes abs logFC distribution**
```{r abslogFC P53, echo=TRUE, message=FALSE}
# Load necessary libraries
library(dplyr)
library(ggplot2)
library(tidyr)
library(org.Hs.eg.db)
library(rstatix)

# **ðŸ”¹ Read P53 Target Genes List**
P53_Target <- read.csv("data/P53_Target.csv", stringsAsFactors = FALSE)

# **ðŸ”¹ Convert gene symbols to Entrez IDs**
P53_Target <- P53_Target %>%
  mutate(Entrez_ID = mapIds(org.Hs.eg.db,
                            keys = Symbol,
                            column = "ENTREZID",
                            keytype = "SYMBOL",
                            multiVals = "first"))

P53_Target_genes <- na.omit(P53_Target$Entrez_ID)

# **ðŸ”¹ Combine all subset_toptables into a single data frame with metadata**
all_toptables <- bind_rows(
  CX_0.1_3 %>% mutate(Drug = "CX.5461", Concentration = 0.1, Timepoint = "3"),
  CX_0.1_24 %>% mutate(Drug = "CX.5461", Concentration = 0.1, Timepoint = "24"),
  CX_0.1_48 %>% mutate(Drug = "CX.5461", Concentration = 0.1, Timepoint = "48"),
  CX_0.5_3 %>% mutate(Drug = "CX.5461", Concentration = 0.5, Timepoint = "3"),
  CX_0.5_24 %>% mutate(Drug = "CX.5461", Concentration = 0.5, Timepoint = "24"),
  CX_0.5_48 %>% mutate(Drug = "CX.5461", Concentration = 0.5, Timepoint = "48"),
  DOX_0.1_3 %>% mutate(Drug = "DOX", Concentration = 0.1, Timepoint = "3"),
  DOX_0.1_24 %>% mutate(Drug = "DOX", Concentration = 0.1, Timepoint = "24"),
  DOX_0.1_48 %>% mutate(Drug = "DOX", Concentration = 0.1, Timepoint = "48"),
  DOX_0.5_3 %>% mutate(Drug = "DOX", Concentration = 0.5, Timepoint = "3"),
  DOX_0.5_24 %>% mutate(Drug = "DOX", Concentration = 0.5, Timepoint = "24"),
  DOX_0.5_48 %>% mutate(Drug = "DOX", Concentration = 0.5, Timepoint = "48")
)

# **ðŸ”¹ Filter data for P53 Target Genes**
filtered_toptables <- all_toptables %>%
  filter(Entrez_ID %in% P53_Target_genes) %>%
  mutate(abs_logFC = abs(logFC))  # Compute absolute logFC

# **ðŸ”¹ Ensure correct ordering of Timepoints & Concentrations**
filtered_toptables <- filtered_toptables %>%
  mutate(
    Drug = factor(Drug, levels = c("CX.5461", "DOX")),  # CX first
    Timepoint = factor(Timepoint, levels = c("3", "24", "48"), 
                       labels = c("Timepoint: 3 hours", "Timepoint: 24 hours", "Timepoint: 48 hours")),
    Concentration = factor(Concentration, levels = c(0.1, 0.5), 
                           labels = c("Concentration: 0.1", "Concentration: 0.5"))
  )

# **ðŸ”¹ Wilcoxon Test for CX vs DOX**
wilcox_results <- filtered_toptables %>%
  group_by(Timepoint, Concentration) %>%
  wilcox_test(abs_logFC ~ Drug) %>%
  adjust_pvalue(method = "bonferroni") %>%
  mutate(significance = ifelse(p < 0.05, "*", ""))  # Assign stars if p < 0.05

# **ðŸ”¹ Determine Y-axis position for Stars**
star_positions <- filtered_toptables %>%
  group_by(Timepoint, Concentration, Drug) %>%
  summarise(y_pos = max(abs_logFC, na.rm = TRUE) + 0.2, .groups = "drop") %>%
  group_by(Timepoint, Concentration) %>%
  summarise(y_pos = max(y_pos), .groups = "drop")

# **ðŸ”¹ Merge Wilcoxon Test results with Star Positions**
wilcox_results_plot <- wilcox_results %>%
  left_join(star_positions, by = c("Timepoint", "Concentration")) %>%
  mutate(x_position = 1.5)  # Place stars in the middle between CX & DOX

# **ðŸ”¹ Generate Boxplot for LogFC of P53 Target Genes**
ggplot(filtered_toptables, aes(x = Drug, y = abs_logFC, fill = Drug)) +
  geom_boxplot() +
  scale_fill_manual(values = c("CX.5461" = "blue", "DOX" = "red")) +  
  facet_grid(Concentration ~ Timepoint) +  
  geom_text(
    data = wilcox_results_plot, 
    aes(x = x_position, y = y_pos, label = significance), 
    size = 6, fontface = "bold", color = "black", inherit.aes = FALSE
  ) +
  theme_bw() +
  xlab("Drugs") +
  ylab("|Log Fold Change|") +  
  ggtitle("|Log Fold Change| for P53 Target Genes") +
  theme(
    plot.title = element_text(size = rel(1.5), hjust = 0.5),
    axis.title = element_text(size = 15, color = "black"),
    axis.line = element_line(linewidth = 1.5),
    strip.background = element_rect(fill = "gray"),  
    strip.text = element_text(size = 12, color = "black", face = "bold"),  
    axis.text.x = element_text(size = 8, color = "black", angle = 15)
  )
```

## **ðŸ“Œ P53 Target Genes logFC distribution**
```{r logFC P53, echo=TRUE, message=FALSE}
# Load necessary libraries
library(dplyr)
library(ggplot2)
library(tidyr)
library(org.Hs.eg.db)
library(car)  # For Levene's Test

# Read P53 Target Genes List
P53_Target <- read.csv("data/P53_Target.csv", stringsAsFactors = FALSE)

# Convert gene symbols to Entrez IDs
P53_Target <- P53_Target %>%
  mutate(Entrez_ID = mapIds(org.Hs.eg.db,
                            keys = Symbol,
                            column = "ENTREZID",
                            keytype = "SYMBOL",
                            multiVals = "first"))

P53_Target_genes <- na.omit(P53_Target$Entrez_ID)

# **ðŸ”¹ Combine all subset_toptables into a single data frame with metadata**
all_toptables <- bind_rows(
  CX_0.1_3 %>% mutate(Drug = "CX.5461", Concentration = 0.1, Timepoint = "3"),
  CX_0.1_24 %>% mutate(Drug = "CX.5461", Concentration = 0.1, Timepoint = "24"),
  CX_0.1_48 %>% mutate(Drug = "CX.5461", Concentration = 0.1, Timepoint = "48"),
  CX_0.5_3 %>% mutate(Drug = "CX.5461", Concentration = 0.5, Timepoint = "3"),
  CX_0.5_24 %>% mutate(Drug = "CX.5461", Concentration = 0.5, Timepoint = "24"),
  CX_0.5_48 %>% mutate(Drug = "CX.5461", Concentration = 0.5, Timepoint = "48"),
  DOX_0.1_3 %>% mutate(Drug = "DOX", Concentration = 0.1, Timepoint = "3"),
  DOX_0.1_24 %>% mutate(Drug = "DOX", Concentration = 0.1, Timepoint = "24"),
  DOX_0.1_48 %>% mutate(Drug = "DOX", Concentration = 0.1, Timepoint = "48"),
  DOX_0.5_3 %>% mutate(Drug = "DOX", Concentration = 0.5, Timepoint = "3"),
  DOX_0.5_24 %>% mutate(Drug = "DOX", Concentration = 0.5, Timepoint = "24"),
  DOX_0.5_48 %>% mutate(Drug = "DOX", Concentration = 0.5, Timepoint = "48")
)

# **ðŸ”¹ Filter data for P53 target genes**
filtered_toptables <- all_toptables %>%
  filter(Entrez_ID %in% P53_Target_genes)

# **ðŸ”¹ Factorize variables for ordered plotting**
filtered_toptables <- filtered_toptables %>%
  mutate(
    Drug = factor(Drug, levels = c("CX.5461", "DOX")),  # CX first
    Timepoint = factor(Timepoint, levels = c("3", "24", "48"), 
                       labels = c("Timepoint: 3 hours", "Timepoint: 24 hours", "Timepoint: 48 hours")),
    Concentration = factor(Concentration, levels = c(0.1, 0.5), 
                           labels = c("Concentration: 0.1", "Concentration: 0.5"))
  )

# **ðŸ”¹ Perform Levene's test for variability differences**
levene_results <- filtered_toptables %>%
  group_by(Timepoint, Concentration) %>%
  summarise(p_value = leveneTest(logFC ~ Drug, data = .)$`Pr(>F)`[1], .groups = "drop") %>%
  mutate(significance = ifelse(p_value < 0.05, "*", ""))  # Use p < 0.05 threshold for stars

# **ðŸ”¹ Determine Y-axis position for Stars**
star_positions <- filtered_toptables %>%
  group_by(Timepoint, Concentration, Drug) %>%
  summarise(y_pos = max(logFC, na.rm = TRUE) + 0.5, .groups = "drop") %>%
  group_by(Timepoint, Concentration) %>%
  summarise(y_pos = max(y_pos), .groups = "drop")

# **ðŸ”¹ Merge Levene test results with Y positions**
levene_results_plot <- levene_results %>%
  left_join(star_positions, by = c("Timepoint", "Concentration")) %>%
  mutate(x_position = 1.5)  # Centered between CX & DOX

# **ðŸ”¹ Generate Violin Plot with Boxplot & Significance Stars**
ggplot(filtered_toptables, aes(x = Drug, y = logFC, fill = Drug)) +
  geom_violin(trim = FALSE, alpha = 0.5) +  # Violin plot for logFC
  geom_boxplot(width = 0.1, outlier.shape = NA, color = "black", alpha = 0.5) +  # Add boxplot inside violin
  scale_fill_manual(values = c("CX.5461" = "blue", "DOX" = "red")) +  
  facet_grid(Concentration ~ Timepoint) +  
  geom_text(
    data = levene_results_plot %>% filter(significance == "*"),  # Only plot significant comparisons
    aes(x = x_position, y = y_pos, label = significance), 
    size = 6, fontface = "bold", color = "black", inherit.aes = FALSE
  ) +
  theme_bw() +
  xlab("Drugs") +
  ylab("Log Fold Change") +  
  ggtitle("Log Fold Change for P53 Target Genes") +
  theme(
    plot.title = element_text(size = rel(1.5), hjust = 0.5),
    axis.title = element_text(size = 15, color = "black"),
    axis.line = element_line(linewidth = 1.5),
    strip.background = element_rect(fill = "gray"),  
    strip.text = element_text(size = 12, color = "black", face = "bold"),  
    axis.text.x = element_text(size = 8, color = "black", angle = 15)
  )
```

## **ðŸ“Œ Generate Boxplots for P53 Target Genes**
```{r P53 Target Genes, echo=TRUE, message=FALSE}
for (gene in p53_target_genes) {
  data_info <- process_gene_data(gene)
  p <- ggplot(data_info$long_data, aes(x = Condition, y = log2CPM, fill = Drug)) +
    geom_boxplot(outlier.shape = NA) +
    scale_fill_manual(values = c("CX" = "#0000FF", "DOX" = "#e6d800", "VEH" = "#FF00FF")) +
    geom_point(aes(color = Indv), size = 2, alpha = 0.5, position = position_jitter(width = 0.2, height = 0)) +
    geom_text(data = data_info$significance_labels, aes(x = Condition, y = max_log2CPM + 0.5, label = Significance),
              inherit.aes = FALSE, size = 6, color = "black") +
    ggtitle(paste("Log2CPM Expression of", gene)) +
    labs(x = "Treatment", y = "log2CPM") +
    theme_bw() +
    theme(plot.title = element_text(size = rel(2), hjust = 0.5),
          axis.title = element_text(size = 15, color = "black"),
          axis.text.x = element_text(size = 10, color = "black", angle = 90, hjust = 1))
  
  print(p)
}
```



